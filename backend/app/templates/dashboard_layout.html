<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}客服中心{% endblock %}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root{
      --main-color:#527586; --main-color-hover:#406172;
      --bs-primary:#527586; --bs-primary-rgb:82,117,134;
      --sidebar-bg:#ffffff; --sidebar-border:#e6ebef; --sidebar-text:#0f172a;
      --sidebar-muted:#6b7280; --sidebar-item-hover:rgba(82,117,134,.08);
      --sidebar-item-active:rgba(82,117,134,.12); --badge-bg:#e9eef2; --badge-text:#324554;
      --sidebar-wide:272px; --sidebar-narrow:88px; --radius-lg:16px;
      --font-base:14px; --font-title:18px; --font-badge:12px;
      --font-icon:1.15rem; --font-icon-collapsed:1.25rem;
    }
    html,body{height:100%;}
    body{background:#f8fafc; font-size:var(--font-base); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
    .layout{ display:flex; min-height:100vh; width:100%; }

    /* Sidebar */
    .sidebar{
      width:var(--sidebar-wide); flex:0 0 var(--sidebar-wide);
      background:var(--sidebar-bg); border-right:1px solid var(--sidebar-border);
      padding:20px 16px; transition: width .2s ease, padding .2s ease;
      position: sticky; top: 0; height: 100vh; overflow:auto; -webkit-overflow-scrolling:touch; overscroll-behavior:contain;
      font-size:var(--font-base);
    }
    .sidebar-brand{ position: sticky; top: 0; z-index: 1; background:var(--sidebar-bg); padding-bottom:6px; margin-bottom:12px; display:flex; align-items:center; justify-content:space-between; }
    .brand-left{display:flex; align-items:center; gap:12px;}
    .brand-avatar{ width:44px; height:44px; border-radius:12px; background:var(--main-color); color:#fff; display:flex; align-items:center; justify-content:center; font-weight:800; letter-spacing:.02em; box-shadow:0 6px 14px rgba(82,117,134,.25); flex-shrink:0; }
    .brand-title{ font-size:var(--font-title); font-weight:800; color:var(--sidebar-text); letter-spacing:.2px; white-space:nowrap; }
    .brand-close{ border:0; background:transparent; color:#7c8a95; font-size:20px; line-height:1; padding:6px 8px; border-radius:10px; }
    .brand-close:hover{background:var(--sidebar-item-hover); color:#4a5a64;}
    .s-nav{ list-style:none; padding:8px 6px 16px; margin:0; display:flex; flex-direction:column; gap:6px; }
    .s-link{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-radius:var(--radius-lg); text-decoration:none; color:var(--sidebar-text); transition:background-color .15s ease,color .15s ease; }
    .s-link:hover{ background:var(--sidebar-item-hover); }
    .s-link.active{ background:var(--sidebar-item-active); color:var(--main-color); font-weight:700; }
    .s-left{display:flex; align-items:center; gap:10px; min-width:0;}
    .s-icon{font-size:var(--font-icon); color:#5f7080; flex-shrink:0;}
    .s-link.active .s-icon{color:var(--main-color);}
    .s-text{font-size:var(--font-base); white-space:nowrap;}
    .s-badge{ min-width:30px; padding:0 8px; text-align:center; font-weight:700; border-radius:999px; font-size:var(--font-badge); background:var(--badge-bg); color:#324554; margin-left:8px; line-height:20px; }

    /* 子選單 */
    .s-subnav{ list-style:none; padding-left:0; margin:4px 0 10px 0; }
    .s-sublink{ display:flex; align-items:center; gap:10px; padding:8px 12px 8px 36px; text-decoration:none; border-radius:12px; color:#334155; }
    .s-sublink:hover{ background:var(--sidebar-item-hover); }
    .s-sublink.active{ background:var(--sidebar-item-active); color:var(--main-color); font-weight:700; }
    .s-subnav-level3{ list-style:none; padding-left:0; margin:4px 0 8px; }
    .s-sublink-l3{ display:flex; align-items:center; gap:8px; padding:8px 12px 8px 52px; text-decoration:none; border-radius:10px; color:#334155; }
    .s-sublink-l3:hover{ background:var(--sidebar-item-hover); }
    .s-sublink-l3.active{ background:var(--sidebar-item-active); color:var(--main-color); font-weight:700; }
    .caret{ transition: transform .15s ease; color:#64748b; }
    .caret.rotate{ transform: rotate(90deg); }

    /* Sidebar collapsed */
    .sidebar-collapsed .sidebar{ width:var(--sidebar-narrow); flex-basis:var(--sidebar-narrow); padding:20px 12px; }
    .sidebar-collapsed .sidebar-brand{ justify-content:center; }
    .sidebar-collapsed .brand-left{ width:100%; justify-content:center; }
    .sidebar-collapsed .brand-title, .sidebar-collapsed .brand-close, .sidebar-collapsed .s-text, .sidebar-collapsed .s-badge, .sidebar-collapsed .caret{ display:none !important; }
    .sidebar-collapsed .s-nav{ align-items:center; }
    .sidebar-collapsed .s-link{ justify-content:center; align-items:center; padding:0; width:56px; height:56px; border-radius:16px; }
    .sidebar-collapsed .s-left{gap:0;}
    .sidebar-collapsed .s-icon{ font-size:var(--font-icon-collapsed); color:#5f7080; }
    .sidebar-collapsed .s-link.active{ background:var(--sidebar-item-active); }

    /* Main / Topbar */
    .main{flex:1 1 auto; display:flex; flex-direction:column; min-width:0;}
    .topbar{ position: sticky; top: 0; z-index: 1030; height:56px; border-bottom:1px solid #dee2e6; background:#fff; display:flex; align-items:center; justify-content:space-between; padding:0 16px 0 12px; transition: box-shadow .15s ease, backdrop-filter .15s ease, background-color .15s ease; backdrop-filter: saturate(110%); font-size:var(--font-base); }
    .topbar.is-scrolled{ box-shadow:0 2px 10px rgba(15,23,42,.08); background:rgba(255,255,255,.98); }
    .menu-btn{ border:0; background:transparent; padding:4px 6px; color:#3b4b55; display:inline-flex; align-items:center; justify-content:center; }
    .menu-btn .bi{ font-size:1.45rem; }
    .avatar{ width:32px; height:32px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; background:var(--main-color); color:#fff; font-weight:600; }
    .user-name{font-weight:600;} .user-email{font-size:.85rem; color:#6b7280;}
    .badge.bg-primary{background:var(--main-color)!important;}
    .btn-primary{background:var(--main-color); border-color:var(--main-color); color:#fff;}
    .btn-primary:hover{background:var(--main-color-hover); border-color:var(--main-color-hover);}
    .btn-outline-primary{color:var(--main-color); border-color:var(--main-color);}
    .btn-outline-primary:hover{background:var(--main-color); color:#fff; border-color:var(--main-color);}
    .page-body{padding:24px; font-size:var(--font-base);}
    @media (max-width: 575.98px){ .page-body{padding:16px;} }
    table, .table, .dataTable, .datatable, .table *{ font-size:var(--font-base) !important; line-height:1.45; }
    .table th{ font-weight:600; color:#475569; }
  </style>
</head>
<body>
<div id="layout" class="layout">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-brand">
      <div class="brand-left">
        <div class="brand-avatar">客</div>
        <div class="brand-title">客服中心</div>
      </div>
      <button id="btnCollapse" class="brand-close" type="button" title="關閉（收合為僅圖示欄）">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>

    <ul class="s-nav">
      <!-- 儀表板 -->
      <li>
        <a class="s-link {% if active_page == 'dashboard' %}active{% endif %}" href="{{ url_for('dash.dashboard') }}">
          <span class="s-left">
            <i class="bi bi-house-door s-icon"></i>
            <span class="s-text">儀表板</span>
          </span>
        </a>
      </li>



      <!-- 其它原有功能 -->
      <li>
        <a class="s-link {% if active_page == 'projects' %}active{% endif %}" href="{{ url_for('project.project_list') }}">
          <span class="s-left">
            <i class="bi bi-folder2-open s-icon"></i>
            <span class="s-text">專案管理</span>
          </span>
        </a>
      </li>

      <li>
        <a class="s-link {% if active_page == 'tickets' %}active{% endif %}" href="{{ url_for('ticket.ticket_list') }}">
          <span class="s-left">
            <i class="bi bi-person-lines-fill s-icon"></i>
            <span class="s-text">客服管理</span>
          </span>
        </a>
      </li>

     <!-- 報表管理 -->
      <li>
        {% set reports_open = (ACTIVE_MENU == 'reports') %}
        <a class="s-link" data-bs-toggle="collapse" href="#m-reports" role="button" aria-expanded="{{ 'true' if reports_open else 'false' }}" aria-controls="m-reports">
          <span class="s-left">
            <i class="bi bi-bar-chart s-icon"></i>
            <span class="s-text">報表管理</span>
          </span>
          <i class="bi bi-caret-right-fill caret {% if reports_open %}rotate{% endif %}"></i>
        </a>

        <div class="collapse {% if reports_open %}show{% endif %}" id="m-reports" data-menu-id="m-reports">
          <ul class="s-subnav">

            <!-- 客服單報表 -->
            <li>
              {% set t_open = (ACTIVE_SUBMENU == 'tickets') %}
              <a class="s-sublink {% if t_open %}active{% endif %}" data-bs-toggle="collapse" href="#m-reports-tickets" role="button" aria-expanded="{{ 'true' if t_open else 'false' }}" aria-controls="m-reports-tickets">
                <i class="bi bi-person-lines-fill"></i>
                <span>客服單報表</span>
                <i class="bi bi-caret-right-fill ms-auto caret {% if t_open %}rotate{% endif %}"></i>
              </a>
              <div class="collapse {% if t_open %}show{% endif %}" id="m-reports-tickets" data-menu-id="m-reports-tickets">
                <ul class="s-subnav-level3">
                  <li><a class="s-sublink-l3 {% if ACTIVE_ITEM == 'tickets_status' %}active{% endif %}" href="/reports/tickets/status">狀態分布</a></li>
                  <li><a class="s-sublink-l3 {% if ACTIVE_ITEM == 'tickets_trend' %}active{% endif %}" href="/reports/tickets/trend">進度趨勢</a></li>
                  <li><a class="s-sublink-l3 {% if ACTIVE_ITEM == 'tickets_eff' %}active{% endif %}" href="/reports/tickets/efficiency">處理效率</a></li>
                </ul>
              </div>
            </li>

            <!-- 專案報表 -->
            <li>
              {% set p_open = (ACTIVE_SUBMENU == 'projects') %}
              <a class="s-sublink {% if p_open %}active{% endif %}" data-bs-toggle="collapse" href="#m-reports-projects" role="button" aria-expanded="{{ 'true' if p_open else 'false' }}" aria-controls="m-reports-projects">
                <i class="bi bi-folder2-open"></i>
                <span>專案報表</span>
                <i class="bi bi-caret-right-fill ms-auto caret {% if p_open %}rotate{% endif %}"></i>
              </a>
              <div class="collapse {% if p_open %}show{% endif %}" id="m-reports-projects" data-menu-id="m-reports-projects">
                <ul class="s-subnav-level3">
                  <li><a class="s-sublink-l3 {% if ACTIVE_ITEM == 'proj_overview' %}active{% endif %}" href="/reports/projects/overview">專案總覽</a></li>
                  <li><a class="s-sublink-l3 {% if ACTIVE_ITEM == 'proj_progress' %}active{% endif %}" href="/reports/projects/progress">進度追蹤</a></li>
                  <li><a class="s-sublink-l3 {% if ACTIVE_ITEM == 'proj_category' %}active{% endif %}" href="/reports/projects/category">分類分布</a></li>
                </ul>
              </div>
            </li>

            <!-- SLA 報表 -->
            <li>
              {% set s_open = (ACTIVE_SUBMENU == 'sla') %}
              <a class="s-sublink {% if s_open %}active{% endif %}" data-bs-toggle="collapse" href="#m-reports-sla" role="button" aria-expanded="{{ 'true' if s_open else 'false' }}" aria-controls="m-reports-sla">
                <i class="bi bi-stopwatch"></i>
                <span>SLA 報表</span>
                <i class="bi bi-caret-right-fill ms-auto caret {% if s_open %}rotate{% endif %}"></i>
              </a>
              <div class="collapse {% if s_open %}show{% endif %}" id="m-reports-sla" data-menu-id="m-reports-sla">
                <ul class="s-subnav-level3">
                  <li><a class="s-sublink-l3 {% if ACTIVE_ITEM == 'sla_rate' %}active{% endif %}" href="/reports/sla/rate">SLA 達成率</a></li>
                  <li><a class="s-sublink-l3 {% if ACTIVE_ITEM == 'sla_overdue' %}active{% endif %}" href="/reports/sla/overdue">逾期客服單統計</a></li>
                </ul>
              </div>
            </li>



          </ul>
        </div>
      </li>
    </ul>
  </aside>

  <!-- Main -->
  <main class="main">
    <div id="topbar" class="topbar">
      <div class="d-flex align-items-center gap-2">
        <button id="btnExpand" class="menu-btn" type="button" title="展開側欄">
          <i class="bi bi-list"></i>
        </button>
      </div>

      <div class="d-flex align-items-center gap-3">
        {% if current_user.is_authenticated %}
        <div class="dropdown">
          <a class="d-flex align-items-center text-dark text-decoration-none" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            <span class="avatar me-2">{{ (current_user.username or current_user.login_account or 'U')[:1] | upper }}</span>
            <div class="d-none d-sm-block text-start">
              <div class="user-name">{{ current_user.username or current_user.login_account }}</div>
              <div class="user-email">{{ current_user.email }}</div>
            </div>
            <i class="bi bi-caret-down-fill ms-2 small text-muted"></i>
          </a>
          <ul class="dropdown-menu dropdown-menu-end">
            <li class="dropdown-header">
              已登入：<strong>{{ current_user.username or current_user.login_account }}</strong><br>
              <small class="text-muted">{{ current_user.email }}</small>
            </li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>帳號設定</a></li>
            <li>
              <a class="dropdown-item text-danger" href="{{ url_for('auth.logout') }}">
                <i class="bi bi-box-arrow-right me-2"></i>登出
              </a>
            </li>
          </ul>
        </div>
        {% else %}
        <div class="d-flex align-items-center gap-2">
          <a href="{{ url_for('auth.login') }}" class="btn btn-outline-primary btn-sm">登入</a>
          <a href="{{ url_for('auth.register') }}" class="btn btn-primary btn-sm">註冊</a>
        </div>
        {% endif %}
      </div>
    </div>

    <div class="page-body">
      {% block content %}{% endblock %}
    </div>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  (function(){
    const root = document.getElementById('layout');
    const btnCollapse = document.getElementById('btnCollapse');
    const btnExpand  = document.getElementById('btnExpand');
    const topbar = document.getElementById('topbar');

    /* 側欄收合狀態 */
    const KEY = 'sidebar-state';
    function setCollapsed(){ root.classList.add('sidebar-collapsed'); localStorage.setItem(KEY, 'collapsed'); }
    function setExpanded(){ root.classList.remove('sidebar-collapsed'); localStorage.setItem(KEY, 'expanded'); }
    (function loadState(){ const st = localStorage.getItem(KEY); if (st === 'collapsed') setCollapsed(); else setExpanded(); })();
    btnCollapse?.addEventListener('click', setCollapsed);
    btnExpand?.addEventListener('click', setExpanded);

    /* Sticky topbar 陰影 */
    function onScroll(){ (window.scrollY > 0) ? topbar.classList.add('is-scrolled') : topbar.classList.remove('is-scrolled'); }
    window.addEventListener('scroll', onScroll, {passive:true}); onScroll();

    /* 報表群組展開狀態記憶 */
    const collapseEls = document.querySelectorAll('[data-menu-id]');
    collapseEls.forEach(el=>{
      const id = el.getAttribute('data-menu-id');
      const key = 'collapse:'+id;
      const bsCollapse = bootstrap.Collapse.getOrCreateInstance(el, {toggle:false});
      const st = localStorage.getItem(key);
      if(st === 'show'){ bsCollapse.show(); }
      el.addEventListener('shown.bs.collapse', ()=>{
        localStorage.setItem(key, 'show');
        document.querySelectorAll('[href="#'+id+'"] .caret')?.forEach(c=>c.classList.add('rotate'));
      });
      el.addEventListener('hidden.bs.collapse', ()=>{
        localStorage.setItem(key, 'hide');
        document.querySelectorAll('[href="#'+id+'"] .caret')?.forEach(c=>c.classList.remove('rotate'));
      });
    });
  })();
</script>
</body>
</html>
