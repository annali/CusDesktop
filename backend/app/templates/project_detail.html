{% extends 'dashboard_layout.html' %}
{% block title %}專案總覽{% endblock %}

{% block content %}
{% set _tab = active_tab|default('tickets') %}
<style>
  .mini{font-size:.875rem; color:#64748b;}
  .back-crumb{display:inline-flex; align-items:center; gap:.25rem; color:#475569; text-decoration:none; padding:.25rem .4rem; border-radius:8px; transition:background-color .15s ease, color .15s ease, box-shadow .15s ease;}
  .back-crumb .bi{line-height:1; font-size:1rem;}
  .back-crumb:hover{ background:#f1f5f9; color:#0f172a; text-decoration:none; }
  .meta-dot{opacity:.55;}

  .page-title { font-weight: 800; letter-spacing:.2px; }
  .page-meta { color:#6b7280; }

  .card-smooth{ border:0; border-radius:14px; box-shadow:0 6px 20px rgba(15,23,42,.06); background:#fff; }
  .card-clean{ border:0; border-radius:14px; box-shadow:0 6px 20px rgba(15,23,42,.06); background:#fff; }

  .equal-row { align-items: stretch; }
  .equal-card { height: 100%; }

  .kv{display:flex; justify-content:space-between; align-items:center; padding:.55rem 0; border-bottom:1px dashed #eef2f7;}
  .kv:last-child{border-bottom:0;}
  .kv .key{color:#6b7280;}
  .kv .val{color:#0f172a;}

  .status-pill{ display:inline-flex; align-items:center; gap:.35rem; font-weight:600; font-size:.85rem; background:#fff7e6; color:#b76e00; border:1px solid #ffe2a8; border-radius:999px; padding:.25rem .6rem; }
  .status-pill.done{ background:#ecfdf5; color:#0f766e; border-color:#a7f3d0; }
  .status-pill.plan{ background:#eef2ff; color:#4338ca; border-color:#c7d2fe; }

  .stat-row{display:flex; align-items:center; justify-content:space-between; padding:.45rem .75rem; border-radius:10px; background:#f8fafc; border:1px solid #eef2f7;}
  .stat-row + .stat-row{margin-top:.55rem;}
  .stat-name{color:#475569;}
  .count-badge{ font-weight:700; color:#0f172a; background:#fff; border:1px solid #e5e7eb; border-radius:999px; padding:.15rem .6rem; min-width:3.2rem; text-align:center; }

  .tabs-wrap{ margin-top: 1rem; }
  .tabs-head{ background:#fff; border:1px solid #eef2f7; border-radius:.75rem; padding:.35rem; display:flex; gap:.35rem; align-items:center; }
  .tabs-head .nav-link{ border:0; border-radius:.65rem; padding:.5rem .9rem; color:#314a57; transition: background-color .15s ease, color .15s ease, box-shadow .15s ease; }
  .tabs-head .nav-link:not(.active):hover{ background: rgba(var(--bs-primary-rgb), .06); color:#23343d; }
  .tabs-head .nav-link.active{ background: var(--main-color); color: #fff !important; font-weight:700; box-shadow: 0 4px 12px rgba(82,117,134,.18); }
  .tabs-head .nav-link.active i{ color:#fff; }

  .reply-wrap { border-radius: 16px; background: #f6f9fb; border: 1px solid #e6edf3; padding: 14px 16px; }
  .reply-textarea { width: 100%; min-height: 120px; resize: vertical; border-radius: 12px; border: 2px solid #d7e0e8; padding: 10px 12px; background: #fff; outline: 0; transition: border-color .15s, box-shadow .15s; font-size: 14px; }
  .reply-textarea:focus { border-color: var(--main-color); box-shadow: 0 0 0 .15rem rgba(var(--bs-primary-rgb), .15); }
  .btn-send { display:inline-flex; align-items:center; gap:.35rem; font-size:13px; padding:6px 12px; border-radius:8px; background:#cbd5e1; border-color:#cbd5e1; color:#fff; }
  .btn-send:not([disabled]){ background:var(--main-color); border-color:var(--main-color); }
  .btn-send:not([disabled]):hover{ filter:brightness(.95); }

  .reply-feed { padding: 0 2px 1rem; }
  .feed-item{ position:relative; padding: 1rem 1rem 1rem 2.25rem; border-left: 3px solid #eef2f7; }
  .feed-item + .feed-item{ margin-top: .75rem; }
  .feed-item .dot{ position:absolute; left:-6px; top:1.25rem; width:14px; height:14px; border-radius:50%; background:#fff; border:3px solid var(--main-color); }
  .feed-head{ display:flex; justify-content:space-between; align-items:center; }
  .feed-name{ font-weight:700; color:#0f172a; display:flex; gap:.5rem; align-items:center; }
  .feed-date{ color:#94a3b8; font-size:.9rem; display:flex; gap:.35rem; align-items:center; }
  /* 核心：保留換行與空白 */
  .feed-body{ margin-top:.35rem; color:#1f2937; line-height:1.75; white-space: pre-wrap; word-break: break-word; }
  .feed-body, .feed-item, .feed-item *{ overflow: visible; }

  /* ====== 與截圖一致的工具列 ====== */
  .toolbox{
    display:flex; align-items:center; justify-content:space-between;
    gap:12px; padding:10px 12px; border:1px solid #eef2f7;
    border-radius:12px; background:#f8fafc;
  }
  .toolbox .left{ display:flex; align-items:center; gap:12px; flex:1; min-width:0; }
  .toolbox .title{ font-weight:600; color:#334155; }
  .toolbox .search-form{ display:flex; align-items:center; gap:8px; flex:1; min-width:0; }
  .toolbox .search-group{ flex:1; max-width:560px; min-width:260px; }
  .toolbox .search-group .form-control{ height:40px; }
  .toolbox .search-group .input-group-text{ height:40px; }
  .toolbox .right{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }

  .num-badge{ background:#e2e8f0; color:#0f172a; padding:.1rem .45rem; border-radius:999px; font-size:.85rem; font-weight:600 }

  /* 附件 */
  .files-section .section-title{font-weight:700; color:#0f172a;}
  .file-toolbar .input-group-text{cursor:pointer;}
  .table-files td,.table-files th{vertical-align:middle;}
  .table-files .btn{padding:.2rem .5rem;}
  .empty-files{ display:flex; align-items:center; justify-content:center; gap:.5rem; color:#64748b; min-height:180px; text-align:center; }
  .empty-files .bi{ font-size:1.1rem; opacity:.8; }
  .files-card{ min-height: 180px; }
</style>

<!-- 上方麵包屑 -->
<div class="d-flex align-items-center justify-content-between mb-2">
  <div class="d-flex align-items-center gap-2 mini">
    <a class="back-crumb" href="{{ url_for('project.project_list') }}">
      <i class="bi bi-chevron-left"></i><span>返回列表</span>
    </a>
    <span>代碼 <span class="fw-semibold">{{ meta.code }}</span></span>
    <span class="meta-dot">|</span>
    <span>建立於 {{ meta.created_at }}</span>
  </div>
</div>

<div class="row g-4 equal-row">
  <div class="col-lg-6">
    <div class="card-smooth equal-card">
      <div class="p-3"><div class="fw-bold fs-5 mb-2">專案總覽：{{ p.project_name }}</div></div>
      <div class="px-4 pb-4">
        <div class="fw-bold mb-2">專案詳情</div>
        <div class="mb-3">
          <div class="key mb-1">描述</div>
          <div class="val">{{ p.project_description or '—' }}</div>
        </div>
        <div class="kv"><div class="key">專案負責人：</div><div class="val">{{ manager_name }}</div></div>
        <div class="kv"><div class="key">開始日期：</div><div class="val">{% if p.start_dt %}{{ p.start_dt.strftime('%Y/%m/%d') }}{% else %}—{% endif %}</div></div>
        <div class="kv"><div class="key">結束日期：</div><div class="val">{% if p.end_dt %}{{ p.end_dt.strftime('%Y/%m/%d') }}{% else %}—{% endif %}</div></div>
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card-smooth equal-card">
      <div class="d-flex justify-content-between align-items-center p-3">
        <div class="fw-bold fs-5">專案狀態</div>
        <span class="status-pill {% if p.project_status=='已完成' %}done{% elif p.project_status=='規劃中' %}plan{% endif %}">{{ p.project_status }}</span>
      </div>
      <div class="px-4 pb-4">
        <div class="key mb-2">相關客服單狀態</div>
        <div class="stat-row"><div class="stat-name">處理中</div><div class="count-badge">{{ processing }} 筆</div></div>
        <div class="stat-row"><div class="stat-name">已回覆</div><div class="count-badge">{{ replied }} 筆</div></div>
      </div>
    </div>
  </div>
</div>

<!-- Tabs -->
<div class="tabs-wrap">
  <ul class="nav tabs-head" id="projTabs" role="tablist">
    <li class="nav-item">
      <button class="nav-link {{ 'active' if _tab=='replies' else '' }} d-inline-flex align-items-center gap-1"
              id="tab-replies" data-bs-toggle="tab" data-bs-target="#pane-replies" type="button">
        <i class="bi bi-chat-square-text"></i> 專案回覆（{{ comments|length }}）
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link {{ 'active' if _tab=='tickets' else '' }} d-inline-flex align-items-center gap-1"
              id="tab-tickets" data-bs-toggle="tab" data-bs-target="#pane-tickets" type="button">
        <i class="bi bi-graph-up-arrow"></i> 客服單（{{ tickets|length }}）
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link {{ 'active' if _tab=='files' else '' }} d-inline-flex align-items-center gap-1"
              id="tab-files" data-bs-toggle="tab" data-bs-target="#pane-files" type="button">
        <i class="bi bi-paperclip"></i> 附件（{{ attachments|length }}）
      </button>
    </li>
  </ul>

  <div class="tab-content py-3">
    <!-- 回覆 -->
    <div class="tab-pane fade {{ 'show active' if _tab=='replies' else '' }}" id="pane-replies" role="tabpanel" aria-labelledby="tab-replies">
      <div class="reply-wrap mb-3">
        <form id="replyForm" method="post" action="{{ url_for('project.project_comment_add', project_sid=p.project_sid) }}">
          <textarea id="replyContent" name="content" class="reply-textarea" placeholder="輸入您的回覆…" required></textarea>
          <div class="mt-2">
            <button id="btnSend" type="submit" class="btn btn-send" disabled><i class="bi bi-send"></i> 送出</button>
          </div>
        </form>
      </div>

      <div class="reply-feed">
        {% for c in comments %}
          <div class="feed-item">
            <span class="dot"></span>
            <div class="feed-head">
              <div class="feed-name"><i class="bi bi-person"></i>{{ c.author }}</div>
              <div class="feed-date"><i class="bi bi-clock"></i>{% if c.ts %}{{ c.ts.strftime('%Y/%m/%d %H:%M') }}{% endif %}</div>
            </div>
            <!-- 這裡保留換行與空白 -->
            <div class="feed-body">{{ c.content | e }}</div>
          </div>
        {% else %}
          <div class="text-muted px-2 py-1">尚無回覆</div>
        {% endfor %}
      </div>
    </div>

    <!-- 客服單（比照案件樣式；所有操作固定留在 tickets 分頁） -->
    <div class="tab-pane fade {{ 'show active' if _tab=='tickets' else '' }}" id="pane-tickets" role="tabpanel" aria-labelledby="tab-tickets">
      <div class="card card-clean p-3">

        <!-- 工具列（搜尋 + 清除 + 建立） -->
        <div class="toolbox mb-3">
          <div class="left">
            <div class="title">客服單</div>

            <form class="search-form" method="get" action="{{ url_for('project.project_detail', project_sid=p.project_sid) }}">
              <input type="hidden" name="tab" value="tickets">
              <input type="hidden" name="ticket_sort" value="{{ ticket_sort or 'code' }}">
              <input type="hidden" name="ticket_dir" value="{{ ticket_dir or 'asc' }}">

              <div class="input-group search-group">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input class="form-control" name="ticket_q" placeholder="搜尋客服單名稱…" value="{{ ticket_q or '' }}">
              </div>

              <button class="btn btn-primary" type="submit">
                <i class="bi bi-search"></i><span class="d-none d-md-inline"> 搜尋</span>
              </button>

              <a class="btn btn-outline-secondary"
                 href="{{ url_for('project.project_detail', project_sid=p.project_sid, tab='tickets', _anchor='pane-tickets') }}">
                清除
              </a>
            </form>
          </div>

          <div class="right">
            <a class="btn btn-outline-primary" href="{{ url_for('ticket.ticket_create') }}?project_sid={{ p.project_sid }}">
              <i class="bi bi-plus-lg"></i> 新增客服單
            </a>
          </div>
        </div>

        {% macro col_header_tickets(text, key) -%}
          {% set active = (ticket_sort == key) %}
          {% set icon = 'bi-arrow-down-up text-muted' %}
          {% if active and ticket_dir == 'asc' %}{% set icon = 'bi-caret-up-fill' %}{% endif %}
          {% if active and ticket_dir == 'desc' %}{% set icon = 'bi-caret-down-fill' %}{% endif %}
          <a class="text-decoration-none d-inline-flex align-items-center gap-1"
             href="{{ ticket_sort_urls[key] }}">
            <span>{{ text }}</span>
            <i class="bi {{ icon }}"></i>
          </a>
        {%- endmacro %}

        <div class="table-responsive">
          <table class="table align-middle mb-0">
            <thead class="table-light">
            <tr>
              <th style="width:120px;">{{ col_header_tickets('客服單號','code') }}</th>
              <th>{{ col_header_tickets('客服單名稱','name') }}</th>
              <th style="width:120px;">{{ col_header_tickets('負責人','assignee') }}</th>
              <th style="width:160px;">{{ col_header_tickets('建立時間','created_at') }}</th>
              <th style="width:120px;">{{ col_header_tickets('狀態','status') }}</th>
            </tr>
            </thead>
            <tbody>
            {% for t in tickets %}
              <tr>
                <td class="text-nowrap">
                  <a class="link-like" href="{{ url_for('ticket.detail', ticket_sid=t.id, from_project=p.project_sid) }}">{{ t.code }}</a>
                </td>
                <td class="text-truncate">
                  <a class="text-decoration-none link-dark" href="{{ url_for('ticket.detail', ticket_sid=t.id, from_project=p.project_sid) }}">
                    {{ t.name }}
                  </a>
                </td>
                <td>{{ t.assignee or '—' }}</td>
                <td class="text-nowrap">
                  {% if t.created_at %}{{ t.created_at.strftime('%Y/%m/%d %H:%M') }}{% else %}—{% endif %}
                </td>
                <td><span class="{{ t.status_badge }}">{{ t.status_display }}</span></td>
              </tr>
            {% else %}
              <tr><td colspan="5" class="text-center text-muted py-4">尚無客服單</td></tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 附件 -->
    <div class="tab-pane fade {{ 'show active' if _tab=='files' else '' }}" id="pane-files" role="tabpanel" aria-labelledby="tab-files">
      <div class="card card-clean files-section files-card">
        <div class="card-body">

          <form id="uploadForm" class="file-toolbar mb-3" method="post" enctype="multipart/form-data"
                action="{{ url_for('project.project_upload_attachment', project_sid=p.project_sid) }}">
            <div class="input-group">
              <label class="input-group-text btn btn-outline-secondary mb-0" for="fileInput">
                <i class="bi bi-folder2-open me-1"></i> 選擇檔案
              </label>
              <input id="fileInput" class="d-none" type="file" name="file" required>
              <input id="fileNames" class="form-control" type="text" value="" placeholder="未選擇任何檔案" readonly>
              <button id="btnUpload" class="btn btn-primary" type="submit">
                <i class="bi bi-upload"></i> 上傳
              </button>
            </div>
            <div class="form-text mt-1">可一次選擇單一檔案；實際上限依伺服器設定。</div>
          </form>

          {% if attachments %}
            <div class="table-responsive">
              <table class="table table-files align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>檔名</th>
                    <th style="width:120px;">大小</th>
                    <th style="width:180px;">建立時間</th>
                    <th style="width:160px;">操作</th>
                  </tr>
                </thead>
                <tbody>
                  {% for a in attachments %}
                    <tr>
                      <td class="text-truncate"><i class="bi bi-paperclip me-2"></i>{{ a.name }}</td>
                      <td>{{ a.size }}</td>
                      <td class="text-nowrap">{% if a.created_at %}{{ a.created_at.strftime('%Y/%m/%d %H:%M') }}{% endif %}</td>
                      <td class="text-nowrap">
                        <a class="btn btn-sm btn-outline-secondary"
                           href="{{ url_for('project.project_download_attachment', attach_id=a.id) }}">
                          <i class="bi bi-download"></i> 下載
                        </a>
                        <form class="d-inline" method="post"
                              action="{{ url_for('project.project_delete_attachment', attach_id=a.id) }}"
                              onsubmit="return confirm('確定要刪除此檔案嗎？');">
                          <button type="submit" class="btn btn-sm btn-outline-danger">
                            <i class="bi bi-trash"></i> 刪除
                          </button>
                        </form>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="empty-files">
              <i class="bi bi-paperclip"></i>
              <div>尚無附件</div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  // 回覆送出啟用/禁用
  const ta=document.getElementById('replyContent'); const btn=document.getElementById('btnSend'); const frm=document.getElementById('replyForm');
  function toggle(){ if(btn && ta) btn.disabled = !(ta.value.trim().length>0); }
  ta?.addEventListener('input', toggle); toggle();
  ta?.addEventListener('keydown', e=>{ if((e.ctrlKey||e.metaKey)&&e.key==='Enter'&&!btn.disabled) frm.submit(); });
  frm?.addEventListener('submit', e=>{ if(!ta.value.trim()){ e.preventDefault(); toggle(); }});

  // 附件：顯示選取檔名
  const fileInput = document.getElementById('fileInput');
  const fileNames = document.getElementById('fileNames');
  document.getElementById('uploadForm')?.addEventListener('submit', (e)=>{
    if (!fileInput || !fileInput.files || fileInput.files.length === 0){
      e.preventDefault(); alert('請選擇要上傳的檔案');
    }
  });
  fileInput?.addEventListener('change', ()=>{
    const f = fileInput.files && fileInput.files[0];
    fileNames.value = f ? f.name : '';
    if(!f) fileNames.placeholder = '未選擇任何檔案';
  });
})();
</script>
{% endblock %}
